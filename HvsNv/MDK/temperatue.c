#include "stm32f4xx.h"
#include "adc.h"

u8 	TempretureCheckFlag = 0;
s32 	TempAtPa0,TempAtPf8,TempAtPf9,TempAtPf10;

/////////////////////ÈÈÃôµç×è
#define	Res1	4700	//4.7K
#define	BValue	3950
float 	Rt;
#define TEMP_NUM   241
int  nuiTempTab[TEMP_NUM]=
{
	95337,92655,90058,87540,85100,82736,80444,78222,76068,73980,
	71955,69992,68088,66241,64449,62712,61026,59390,57803,56263,
	54769,53318,51911,50544,49217,47929,46679,45464,44285,43140,
	42027,40947,39897,38878,37887,36924,35989,35080,34196,33337,
	32503,31691,30902,30135,29389,28664,27959,27273,26605,25956,
	25325,24711,24113,23532,22966,22415,21879,21357,20850,20355,
	19874,19406,18950,18506,18073,17652,17242,16842,16453,16074,
	15704,15345,14994,14652,14319,13995,13679,13371,13070,12777,
	12492,12213,11942,11677,11419,11168,10922,10683,10449,10222,
	10000,9783,9571,9365,9164,8967,8776,8588,8406,8228,8054,7884,
	7718,7556,7398,7244,7093,6946,6802,6662,6525,6391,6260,6132,
	6007,5885,5766,5650,5536,5425,5316,5210,5106,5004,4905,4808,
	4714,4621,4530,4442,4355,4270,4187,4106,4027,3950,3874,3800,
	3727,3656,3587,3519,3452,3387,3323,3261,3200,3140,3082,3025,
	2969,2914,2860,2808,2756,2706,2657,2608,2561,2515,2470,2425,
	2382,2339,2297,2256,2216,2177,2139,2101,2064,2028,1992,1958,
	1924,1890,1857,1825,1794,1763,1733,1703,1674,1646,1618,1591,
	1564,1537,1512,1486,1461,1437,1413,1390,1367,1344,1322,1300,
	1279,1258,1238,1218,1198,1178,1159,1141,1122,1105,1087,1070,
	1053,1036,1019,1003,988,972,957,942,927,913,899,885,871,858,
	845,832,819,806,794,782,770,759,747,736,725,714,703,693,683,
	672,663, 
	  
};

int trueTempTab[TEMP_NUM]=
{
	-200,-195,-190,-185,-180,-175,-170,-165,-160,-155,
	-150,-145,-140,-135,-130,-125,-120,-115,-110,-105,
	-100,-95,-90,-85,-80,-75,-70,-65,-60,-55,-50,-45,
	-40,-35,-30,-25,-20,-15,-10,-05,00,05,10,15,20,25,
	30,35,40,45,50,55,60,65,70,75,80,85,90,95,100,105,
	110,115,120,125,130,135,140,145,150,155,160,165,170,
	175,180,185,190,195,200,205,210,215,220,225,230,235,
	240,245,250,255,260,265,270,275,280,285,290,295,300,
	305,310,315,320,325,330,335,340,345,350,355,360,365,
	370,375,380,385,390,395,400,405,410,415,420,425,430,
	435,440,445,450,455,460,465,470,475,480,485,490,495,
	500,505,510,515,520,525,530,535,540,545,550,555,560,
	565,570,575,580,585,590,595,600,605,610,615,620,625,
	630,635,640,645,650,655,660,665,670,675,680,685,690,
	695,700,705,710,715,720,725,730,735,740,745,750,755,
	760,765,770,775,780,785,790,795,800,805,810,815,820,
	825,830,835,840,845,850,855,860,865,870,875,880,885,
	890,895,900,905,910,915,920,925,930,935,940,945,950,
	955,960,965,970,975,980,985,990,995,1000,
};

int CalcTemp(int nuiResVal)
{
	int temperature;
	int k;
	int m;
	int nuiTempMin = 0;
	int nuiTempMax = TEMP_NUM;
	int nuiMidVal = 0;

	while(nuiResVal >= nuiTempTab[nuiTempMax])
	{
		nuiMidVal = (nuiTempMax + nuiTempMin) / 2;
		if((nuiMidVal == nuiTempMin) || (nuiMidVal == nuiTempMax))
		{
			break;
		}
		if(nuiResVal >= nuiTempTab[nuiMidVal])
		{
			nuiTempMax = nuiMidVal;
		}
		else
		{
			nuiTempMin = nuiMidVal;
		}
	}
	if (nuiResVal == nuiTempTab[nuiTempMin])
	{
		return trueTempTab[nuiTempMin];
	}
	if (nuiResVal == nuiTempTab[nuiTempMax])
	{
		return trueTempTab[nuiTempMax];
	}
	k = nuiTempTab[nuiTempMin] - nuiTempTab[nuiTempMax];

	m = (trueTempTab[nuiTempMax] - trueTempTab[nuiTempMin]) * (nuiResVal - nuiTempTab[nuiTempMax]) / k;
	temperature = trueTempTab[nuiTempMin] +  m;

	return temperature;
} 
/////////////////////

u8 TemperetureCheckAndActions(void)
{
	u8 ret = 0;
	u16 tt;
	
	tt = Get_Adc3_Average(ADC_Channel_8,ADC_GETAVERAGE_K);
	Rt=(float)tt*(3.3/4096);
	Rt=(Res1*(float)tt)/(4096-(float)tt);
	TempAtPf10 = CalcTemp(Rt);			
	if(TempAtPf10 > TEMPLIMITVALUE){
		ret |= 1<<0;
		//LED_DisResOT_ON;
	}
	tt = Get_Adc3_Average(ADC_Channel_7,ADC_GETAVERAGE_K);
	Rt=(Res1*(float)tt)/(4096-(float)tt);
	TempAtPf9 = CalcTemp(Rt);			
	if(TempAtPf9 > TEMPLIMITVALUE){
		ret |= 1<<1;
		//LED_PreResOT_ON;
	}
	tt = Get_Adc3_Average(ADC_Channel_6,ADC_GETAVERAGE_K);
	Rt=(Res1*(float)tt)/(4096-(float)tt);
	TempAtPf8 = CalcTemp(Rt);			
	if(TempAtPf8 > TEMPLIMITVALUE){
		ret |= 1<<2;
		//LED_PreResOT_ON;
	}
	
	return ret;
}
















































